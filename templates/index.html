<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diet Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-6xl mx-auto space-y-8">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-4xl font-bold text-gray-800">Diet Dashboard</h1>
            <p class="text-gray-600 mt-2">Analysis of daily nutrition intake</p>
        </header>

        <!-- Graph Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Daily Caloric Breakdown</h2>
            <div class="relative h-96 w-full">
                <canvas id="caloriesChart"></canvas>
            </div>
        </div>

        <!-- Interactive Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg min-h-[500px]">
            <!-- Tabs -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchTab('chat')" id="tab-chat" class="flex-1 py-4 px-6 text-center font-medium text-blue-600 border-b-2 border-blue-600 hover:text-blue-800 focus:outline-none">
                    AI Analysis (Chat)
                </button>
                <button onclick="switchTab('sql')" id="tab-sql" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700 focus:outline-none">
                    Manual SQL
                </button>
                <button onclick="switchTab('evals')" id="tab-evals" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700 focus:outline-none">
                    Evals
                </button>
            </div>

            <!-- Chat Tab Content -->
            <div id="content-chat" class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-md text-sm text-blue-800 mb-4">
                    <p>Ask natural language questions about your diet data</p>
                    <p class="font-mono mt-1 text-xs">Example: "Show me the top 5 days with highest protein intake"</p>
                </div>
                
                <div class="flex gap-4">
                    <input type="text" id="chat-input" placeholder="Ask about your diet..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" onkeypress="handleEnter(event, 'chat')">
                    <button onclick="sendChat()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium transition-colors">
                        Ask AI
                    </button>
                </div>

                <div id="chat-loading" class="hidden text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>

                <div id="chat-result" class="hidden space-y-4">
                    <div class="bg-gray-50 p-4 rounded border border-gray-200">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">DB Queries</span>
                            <span id="query-count" class="text-xs bg-gray-200 px-2 py-1 rounded">0</span>
                        </div>
                        <div id="chat-queries" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Queries will be added here dynamically -->
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded border border-gray-200">
                        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">AI Response</span>
                        <div id="chat-response" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>

            <!-- SQL Tab Content -->
            <div id="content-sql" class="space-y-4 hidden">
                <div class="bg-gray-50 p-4 rounded-md text-sm text-gray-700 mb-4">
                    <p>Execute raw SQL queries against the 'servings_apr_25' table.</p>
                    <p class="font-mono mt-1 text-xs">Schema includes: day, food_name, amount, energy_kcal, carbs_g, fat_g, protein_g...</p>
                </div>

                <textarea id="sql-input" rows="5" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-gray-500 focus:border-gray-500 shadow-sm" placeholder="SELECT * FROM servings_apr_25 LIMIT 10"></textarea>
                
                <div class="flex justify-end">
                    <button onclick="runSQL()" class="bg-gray-700 text-white px-6 py-3 rounded-lg hover:bg-gray-800 font-medium transition-colors">
                        Run Query
                    </button>
                </div>

                <div id="sql-loading" class="hidden text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-700"></div>
                </div>

                <div id="sql-result" class="hidden bg-white border rounded overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="sql-table">
                            <!-- Data populated by JS -->
                        </table>
                    </div>
                </div>
                 <div id="sql-error" class="hidden p-4 text-red-600 bg-red-50 rounded border border-red-200"></div>

            </div>

            <!-- Evals Tab Content -->
            <div id="content-evals" class="space-y-4 hidden">
                <div class="bg-purple-50 p-4 rounded-md text-sm text-purple-800 mb-4">
                    <p>Test AI responses against expected answers. Click "Run" to evaluate each question or "Run All" to test all at once.</p>
                </div>

                <div class="flex justify-end mb-4">
                    <button onclick="runAllEvals()" id="run-all-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-medium transition-colors">
                        Run All Evals
                    </button>
                </div>

                <div id="evals-summary" class="hidden bg-gray-100 p-4 rounded-lg mb-4">
                    <div class="flex items-center gap-4">
                        <span class="font-semibold text-gray-700">Results:</span>
                        <span id="evals-passed" class="text-green-600 font-medium">0 passed</span>
                        <span id="evals-failed" class="text-red-600 font-medium">0 failed</span>
                    </div>
                </div>

                <div id="evals-container" class="space-y-4">
                    <!-- Eval items will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Init
        document.addEventListener('DOMContentLoaded', loadStats);

        // Fetch and Render Chart
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.data) {
                    renderChart(data.data, data.meta);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function renderChart(rows, meta) {
            // data.data is an array of objects
            const labels = rows.map(r => r.date);
            
            // Convert grams to kcal
            // Carbs: 4 kcal/g, Protein: 4 kcal/g, Fat: 9 kcal/g
            const carbsData = rows.map(r => r.carbs * 4);
            const proteinData = rows.map(r => r.protein * 4);
            const fatData = rows.map(r => r.fat * 9);

            const ctx = document.getElementById('caloriesChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Carbs (kcal)',
                            data: carbsData,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            stack: 'Stack 0',
                        },
                        {
                            label: 'Protein (kcal)',
                            data: proteinData,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            stack: 'Stack 0',
                        },
                        {
                            label: 'Fat (kcal)',
                            data: fatData,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            stack: 'Stack 0',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Calories' } }
                    }
                }
            });
        }

        // Tab Switching
        function switchTab(tab) {
            const tabs = ['chat', 'sql', 'evals'];
            const buttons = {
                chat: document.getElementById('tab-chat'),
                sql: document.getElementById('tab-sql'),
                evals: document.getElementById('tab-evals')
            };
            const contents = {
                chat: document.getElementById('content-chat'),
                sql: document.getElementById('content-sql'),
                evals: document.getElementById('content-evals')
            };

            // Reset all tabs
            tabs.forEach(t => {
                buttons[t].classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                buttons[t].classList.add('text-gray-500');
                contents[t].classList.add('hidden');
            });

            // Activate selected tab
            buttons[tab].classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            buttons[tab].classList.remove('text-gray-500');
            contents[tab].classList.remove('hidden');

            // Render evals when switching to evals tab
            if (tab === 'evals') {
                renderEvals();
            }
        }

        function handleEnter(e, type) {
            if (e.key === 'Enter') {
                if (type === 'chat') sendChat();
            }
        }

        // Chat Functionality with Streaming
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;

            // Reset UI
            document.getElementById('chat-loading').classList.remove('hidden');
            document.getElementById('chat-result').classList.add('hidden');
            document.getElementById('chat-queries').innerHTML = '';
            document.getElementById('chat-response').textContent = '';
            document.getElementById('query-count').textContent = '0';

            let queryCount = 0;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                // Show result container
                document.getElementById('chat-loading').classList.add('hidden');
                document.getElementById('chat-result').classList.remove('hidden');

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Process complete SSE messages (ending with \n\n)
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // Keep incomplete message in buffer
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6); // Remove 'data: ' prefix
                            try {
                                const event = JSON.parse(jsonStr);
                                
                                if (event.type === 'query') {
                                    queryCount++;
                                    addQueryToUI(event.data, queryCount);
                                    document.getElementById('query-count').textContent = queryCount;
                                } else if (event.type === 'result') {
                                    document.getElementById('chat-response').textContent = event.data;
                                } else if (event.type === 'error') {
                                    alert('Error: ' + event.data);
                                }
                            } catch (e) {
                                console.error('Failed to parse event:', e, jsonStr);
                            }
                        }
                    }
                }
                
            } catch (e) {
                console.error(e);
                alert('Request failed: ' + e.message);
                document.getElementById('chat-loading').classList.add('hidden');
            }
        }

        function addQueryToUI(sql, index) {
            const queriesContainer = document.getElementById('chat-queries');
            
            const queryDiv = document.createElement('div');
            queryDiv.className = 'bg-white p-3 rounded border border-gray-300 animate-fade-in';
            
            const header = document.createElement('div');
            header.className = 'flex items-center gap-2 mb-1';
            
            const badge = document.createElement('span');
            badge.className = 'text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded';
            badge.textContent = `Query ${index}`;
            
            const spinner = document.createElement('span');
            spinner.className = 'text-xs text-gray-500 flex items-center gap-1';
            spinner.innerHTML = '<span class="inline-block animate-pulse">⚡</span> Executing...';
            
            header.appendChild(badge);
            header.appendChild(spinner);
            
            const code = document.createElement('pre');
            code.className = 'mt-2 text-xs text-gray-700 overflow-x-auto whitespace-pre-wrap font-mono bg-gray-50 p-2 rounded';
            code.textContent = sql;
            
            queryDiv.appendChild(header);
            queryDiv.appendChild(code);
            queriesContainer.appendChild(queryDiv);
            
            // Remove spinner after a short delay
            setTimeout(() => {
                spinner.innerHTML = '<span class="text-green-600">✓</span> Complete';
            }, 300);
            
            // Scroll to bottom of queries container
            queriesContainer.scrollTop = queriesContainer.scrollHeight;
        }

        // SQL Functionality
        async function runSQL() {
            const input = document.getElementById('sql-input');
            const query = input.value.trim();
            if (!query) return;

            document.getElementById('sql-loading').classList.remove('hidden');
            document.getElementById('sql-result').classList.add('hidden');
            document.getElementById('sql-error').classList.add('hidden');

            try {
                const res = await fetch('/api/sql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await res.json();
                
                document.getElementById('sql-loading').classList.add('hidden');
                if (data.error) {
                    const errDiv = document.getElementById('sql-error');
                    errDiv.textContent = data.error;
                    errDiv.classList.remove('hidden');
                    return;
                }
                
                document.getElementById('sql-result').classList.remove('hidden');
                renderTable('sql-table', data);

            } catch (e) {
                console.error(e);
                alert('Request failed');
                document.getElementById('sql-loading').classList.add('hidden');
            }
        }

        // Generic Table Renderer
        function renderTable(tableId, data) {
            const table = document.getElementById(tableId);
            table.innerHTML = ''; // Clear

            if (!data || !data.meta || !data.data || data.data.length === 0) {
                table.innerHTML = '<tr><td class="p-4 text-gray-500">No results found</td></tr>';
                return;
            }

            // Header
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            const headerRow = document.createElement('tr');
            data.meta.forEach(col => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = col.name;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Body
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            data.data.forEach(row => {
                const tr = document.createElement('tr');
                // Tinybird data is usually array of objects mapping field->value for JSON format
                // row is { "day": "...", "amount": ... }
                data.meta.forEach(col => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    td.textContent = row[col.name];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
        }

        // Pre-filled evaluation questions and expected answers
        const evalQuestions = [
            {
                id: 1,
                question: 'Which day was the most sugar eaten, and how much? Round to the nearest integer. Output in the format "DATE AMOUNT", for example: "2021-03-15 99g"',
                expectedAnswer: '2023-10-06 195g'
            },
            {
                id: 2,
                question: 'What was the most Vitamin C consumed in one serving? What food item was it, and how much Vitamin C? Round to the nearest integer. Just output the food name, not the cooking method. Format the answer like this: "FOOD AMOUNT", for example: "Sweet Potato 57mg"',
                expectedAnswer: 'Broccoli 294mg'
            },
            {
                id: 3,
                question: 'What was the top 3 amounts of calories consumed per day? Output a comma-separated list of calories in descending order, rounding the calorie amounts to the nearest integer. Example: "6000, 5000, 4000"',
                expectedAnswer: '4389, 4082, 3738'
            }
        ];

        // Track eval results
        let evalResults = {};

        function renderEvals() {
            const container = document.getElementById('evals-container');
            
            // Only render if empty (avoid re-rendering and losing state)
            if (container.children.length > 0) return;

            evalQuestions.forEach((evalItem, index) => {
                const evalDiv = document.createElement('div');
                evalDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm';
                evalDiv.id = `eval-item-${evalItem.id}`;

                evalDiv.innerHTML = `
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-semibold bg-purple-100 text-purple-800 px-2 py-1 rounded">Eval #${evalItem.id}</span>
                                <span id="eval-status-${evalItem.id}" class="text-2xl"></span>
                            </div>
                            <p class="text-sm text-gray-700 mb-3">${evalItem.question}</p>
                            <div class="bg-gray-50 p-3 rounded mb-3">
                                <span class="text-xs font-semibold text-gray-500 uppercase">Expected Answer:</span>
                                <p class="text-sm font-mono text-gray-800 mt-1">${evalItem.expectedAnswer}</p>
                            </div>
                            <div id="eval-result-${evalItem.id}" class="hidden">
                                <div class="bg-blue-50 p-3 rounded">
                                    <span class="text-xs font-semibold text-blue-600 uppercase">AI Response:</span>
                                    <p id="eval-response-${evalItem.id}" class="text-sm font-mono text-gray-800 mt-1"></p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-2">
                            <button onclick="runEval(${evalItem.id})" id="eval-run-btn-${evalItem.id}" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-medium transition-colors text-sm">
                                Run
                            </button>
                            <div id="eval-loading-${evalItem.id}" class="hidden">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(evalDiv);
            });
        }

        async function runEval(evalId) {
            const evalItem = evalQuestions.find(e => e.id === evalId);
            if (!evalItem) return;

            // Show loading, hide button
            document.getElementById(`eval-loading-${evalId}`).classList.remove('hidden');
            document.getElementById(`eval-run-btn-${evalId}`).classList.add('hidden');
            document.getElementById(`eval-status-${evalId}`).textContent = '';
            document.getElementById(`eval-result-${evalId}`).classList.add('hidden');

            try {
                const aiResponse = await sendEvalQuery(evalItem.question);
                
                // Show result
                document.getElementById(`eval-result-${evalId}`).classList.remove('hidden');
                document.getElementById(`eval-response-${evalId}`).textContent = aiResponse;

                // Check if answer matches (exact match)
                const isCorrect = aiResponse.trim() === evalItem.expectedAnswer.trim();
                
                // Update status icon
                const statusEl = document.getElementById(`eval-status-${evalId}`);
                if (isCorrect) {
                    statusEl.innerHTML = '<span class="text-green-600">✓</span>';
                    evalResults[evalId] = true;
                } else {
                    statusEl.innerHTML = '<span class="text-red-600">✗</span>';
                    evalResults[evalId] = false;
                }

                updateEvalsSummary();

            } catch (e) {
                console.error('Eval failed:', e);
                document.getElementById(`eval-status-${evalId}`).innerHTML = '<span class="text-red-600">⚠</span>';
                evalResults[evalId] = false;
            } finally {
                // Hide loading, show button
                document.getElementById(`eval-loading-${evalId}`).classList.add('hidden');
                document.getElementById(`eval-run-btn-${evalId}`).classList.remove('hidden');
            }
        }

        async function sendEvalQuery(question) {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: question })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let result = '';

            while (true) {
                const { done, value } = await reader.read();
                
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                
                // Process complete SSE messages
                const lines = buffer.split('\n\n');
                buffer = lines.pop();
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.substring(6);
                        try {
                            const event = JSON.parse(jsonStr);
                            if (event.type === 'result') {
                                result = event.data;
                            } else if (event.type === 'error') {
                                throw new Error(event.data);
                            }
                        } catch (e) {
                            if (e.message !== 'Unexpected end of JSON input') {
                                console.error('Failed to parse event:', e);
                            }
                        }
                    }
                }
            }

            return result;
        }

        async function runAllEvals() {
            // Disable run all button
            const runAllBtn = document.getElementById('run-all-btn');
            runAllBtn.disabled = true;
            runAllBtn.classList.add('opacity-50', 'cursor-not-allowed');
            runAllBtn.textContent = 'Running...';

            // Reset results
            evalResults = {};

            // Run each eval sequentially
            for (const evalItem of evalQuestions) {
                await runEval(evalItem.id);
            }

            // Re-enable button
            runAllBtn.disabled = false;
            runAllBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            runAllBtn.textContent = 'Run All Evals';
        }

        function updateEvalsSummary() {
            const summaryDiv = document.getElementById('evals-summary');
            const passedCount = Object.values(evalResults).filter(r => r === true).length;
            const failedCount = Object.values(evalResults).filter(r => r === false).length;

            if (passedCount > 0 || failedCount > 0) {
                summaryDiv.classList.remove('hidden');
                document.getElementById('evals-passed').textContent = `${passedCount} passed`;
                document.getElementById('evals-failed').textContent = `${failedCount} failed`;
            }
        }
    </script>
</body>
</html>
